\documentclass{article}

\usepackage{fullpage}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{amsmath}
\usepackage{ebproof}

\newcommand{\evalsto}{\mathrel{\mathop{\Downarrow}}}
\newcommand{\matches}{\mathrel{\mathop{\sim}}}
\newcommand{\hooksto}{\mathrel{\mathop{\hookrightarrow}}}
\newcommand{\steps}{\mathrel{\mathop{\vartriangleright}}}
\newcommand{\skips}{\mathrel{\mathop{\blacktriangleright}}}
\newcommand{\final}{~\mathbf{final}}
\newcommand{\istep}{~\mathbf{step}}
\newcommand{\iskip}{~\mathbf{skip}}
\DeclareMathOperator{\Filter}{Filter}
\DeclareMathOperator{\fskip}{skip}
\DeclareMathOperator{\fstep}{step}
\newcommand{\fin}{\mathrel{\mathop{\text{in}}}}

\begin{document}

\section{Environment-based Evaluation Filter}

\begin{enumerate}
  \item \fbox{\(f\)} Filter.
    \[
      \Filter f = \ast \mid f(f)
    \]
  \item \fbox{\(f \matches d\)} Filter \(f\) matches expression \(d\).
    \[
      \begin{prooftree}
        \hypo{f_1 \matches d_1}
        \hypo{f_2 \matches d_2}
        \infer2{f_1(f_2) \matches d_1(d_2)}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \infer0{\ast \matches d}
      \end{prooftree}
    \]
  \item \fbox{\(\mathcal{F}\)} Filter environment.
    \[
      \mathcal{F} = \varepsilon \mid \mathcal{F}, (f, step) \mid
      \mathcal{F}, (f, skip)
    \]
  \item \fbox{\(\mathcal{F} \steps d\)} Expression \(d\) is marked to be stepped
    through under filter \(\mathcal{F}\).
    \[
      \begin{prooftree}
        \hypo{(f, step) \in \mathcal{F}}
        \hypo{f \matches d}
        \infer2[]{\mathcal{F} \steps d}
      \end{prooftree}
    \]
  \item \fbox{\(\mathcal{F} \skips d\)} Expression \(d\) is marked to be
    skipped over under filter \(\mathcal{F}\).
    \[
      \begin{prooftree}
        \hypo{(f, skip) \in \mathcal{F}}
        \hypo{f \matches d}
        \infer2[]{\mathcal{F} \skips d}
      \end{prooftree}
    \]
  \item \fbox{\(d =_\mathcal{F} \mathcal{E} \{ d' \}\)}: Expression \(d\) can be
    obtained by placing \(d'\) at the marked position in
    \(\mathcal{E}\).
    \[
      \begin{prooftree}
        \hypo{\mathcal{F}' = \mathcal{F}, (f, step)}
        \hypo{d =_{\mathcal{F}'} \mathcal{E} \{ d' \} \iskip}
        \infer2{\fstep f \fin d =_\mathcal{F} \mathcal{E} \{ d' \} \iskip}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{\mathcal{F}' = \mathcal{F}, (f, step)}
        \hypo{d =_{\mathcal{F}'} \mathcal{E} \{ d' \} \istep}
        \infer2{\fstep f \fin d =_\mathcal{F} \mathcal{E} \{ d' \} \istep}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{\mathcal{F}' = \mathcal{F}, (f, skip)}
        \hypo{d =_{\mathcal{F}'} \mathcal{E} \{ d' \} \iskip}
        \infer2{\fstep f \fin d =_\mathcal{F} \mathcal{E} \{ d' \} \iskip}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{\mathcal{F}' = \mathcal{F}, (f, skip)}
        \hypo{d =_{\mathcal{F}'} \mathcal{E} \{ d' \} \istep}
        \infer2{\fstep f \fin d =_\mathcal{F} \mathcal{E} \{ d' \} \istep}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d_1 \final}
        \hypo{d_2 \final}
        \hypo{\mathcal{F} \skips d_1(d_2)}
        \infer3{d_1 (d_2) =_\mathcal{F} \circ \{ d_1(d_2) \} \iskip}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d_1 \final}
        \hypo{d_2 =_\mathcal{F} \circ \{ d_2 \} \iskip}
        \hypo{\mathcal{F} \skips d_1(d_2)}
        \infer3{d_1 (d_2) =_\mathcal{F} \circ \{ d_1(d_2) \} \iskip}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d_1 =_\mathcal{F} \circ \{ d_1 \} \iskip}
        \hypo{d_2 \final}
        \hypo{\mathcal{F} \skips d_1(d_2)}
        \infer3{d_1 (d_2) =_\mathcal{F} \circ \{ d_1(d_2) \} \iskip}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d_1 =_\mathcal{F} \circ \{ d_1 \} \iskip}
        \hypo{d_2 =_\mathcal{F} \circ \{ d_2 \} \iskip}
        \hypo{\mathcal{F} \skips d_1(d_2)}
        \infer3{d_1 (d_2) =_\mathcal{F} \circ \{ d_1(d_2) \} \iskip}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d_1 \final}
        \hypo{d_2 \final}
        \hypo{\mathcal{F} \steps d_1(d_2)}
        \infer3{d_1 (d_2) =_\mathcal{F} \circ \{d_1(d_2)\} \istep}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d_1 \final}
        \hypo{d_2 =_\mathcal{F} \mathcal{E}_2 \{d_2'\} \istep}
        \infer2{d_1(d_2) =_\mathcal{F} d_1(\mathcal{E}_2)\{d_2'\} \istep}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d_1 =_\mathcal{F} \mathcal{E}_1 \{ d_1' \} \istep}
        \hypo{d_2 \final}
        \infer2{d_1(d_2) =_\mathcal{F} \mathcal{E}_1(d_2)\{d_1'\} \istep}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d_1 =_\mathcal{F} \mathcal{E}_1 \{ d_1' \} \istep}
        \hypo{d_2 =_\mathcal{F} \mathcal{E}_2 \{d_2'\} \istep}
        \infer2{
          d_1(d_2)
          =_\mathcal{F}
          \mathcal{E}_1 (d_2) {d_1'}, d_1(\mathcal{E}_2)\{d_2'\} \istep
        }
      \end{prooftree}
    \]
  \item \fbox{\(d \mapsto d'\)} Expression \(d\) steps to expression
    \(d'\).
    \[
      \begin{prooftree}
        \hypo{d =_\mathcal{F} \mathcal{E} \{ d_0 \} \istep}
        \hypo{d_0 \to d_0'}
        \hypo{d' = \mathcal{E} \{ d_0' \}}
        \infer3{d \mapsto_\mathcal{F} d'}
      \end{prooftree}
    \]
    \[
      \begin{prooftree}
        \hypo{d =_\mathcal{F} \mathcal{E} \{ d_0 \} \iskip}
        \hypo{d_0 \evalsto d_0'}
        \hypo{d' = \mathcal{E} \{ d_0' \}}
        \infer3{d \mapsto_\mathcal{F} d'}
      \end{prooftree}
    \]
\end{enumerate}

\section{Example Derivation}

For \(\mathcal{F} = (\ast, step), (\ast \times \ast, skip)\),
\[
  \mathcal{D}_1 = \begin{prooftree}
    \hypo{1 \final}
    \hypo{2 \final}
    \hypo{\mathcal{F} \skips 1 \times 2}
    \infer3{1 \times 2 =_\mathcal{F} \circ \{ 1 \times 2 \} \iskip}
    \hypo{3 \final}
    \hypo{\mathcal{F} \skips (1 \times 2) \times 3}
    \infer3{
      1 \times 2 \times 3
      =_\mathcal{F}
      \circ \{ 1 \times 2 \times 3 \} \iskip
    }
  \end{prooftree}
\]
\[
  \begin{prooftree}
    \hypo{\mathcal{D}_1}
    \hypo{1 \times 2 \times 3 \evalsto 6}
    \hypo{6 = \circ \{ 6 \}}
    \infer3{
      1 \times 2 \times 3 \mapsto_\mathcal{F} 6
    }
  \end{prooftree}
\]

For \(\mathcal{F} = (\ast, skip), (\ast + \ast, step)\),
\[
  \mathcal{D}_2 = \begin{prooftree}
    \hypo{1 \final}
    \hypo{2 \final}
    \hypo{\mathcal{F} \steps 1 + 2}
    \infer3{1 + 2 =_\mathcal{F} \circ \{ 1 + 2 \} \istep}
    \hypo{3 \final}
    \infer2{1 + 2 + 3 =_\mathcal{F} \circ + 3 \{ 1 + 2 \} \istep}
    \hypo{4 \final}
    \infer2{(1 + 2 + 3) \times 4 =_\mathcal{F} (\circ + 3) \times 4 \{ 1 + 2 \} \istep}
  \end{prooftree}
\]
\[
  \begin{prooftree}
    \hypo{\mathcal{D}_2}
    \hypo{1 + 2 \to 3}
    \hypo{(3 + 3) \times 4 = (\circ + 3) \times 4 \{ 3 \}}
    \infer3{(1 + 2 + 3) \times 4 \mapsto_\mathcal{F} (3 + 3) \times 4}
  \end{prooftree}
\]

\end{document}
